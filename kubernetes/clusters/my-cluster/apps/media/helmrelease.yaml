# Radarr
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: radarr
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: radarr
      version: "17.4.0"
      sourceRef:
        kind: HelmRepository
        name: k8s-home-lab
        namespace: media
      interval: 1h
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - mainboy
    persistence:
      media:
        enabled: true
        existingClaim: media-nfs-pvc
        mountPath: /media
      config:
        enabled: true
        existingClaim: radarr-config-pvc
        mountPath: /config

    podSecurityContext:
      fsGroup: 100
      fsGroupChangePolicy: "OnRootMismatch"
---
# Sonarr
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: sonarr
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: sonarr
      version: "17.2.1"
      sourceRef:
        kind: HelmRepository
        name: k8s-home-lab
        namespace: media
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - mainboy
    persistence:
      media:
        enabled: true
        existingClaim: media-nfs-pvc
        mountPath: /media
      config:
        enabled: true
        existingClaim: sonarr-config-pvc
        mountPath: /config

    podSecurityContext:
      fsGroup: 100
      fsGroupChangePolicy: "OnRootMismatch"
---
#Plex
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: plex
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: plex
      version: "7.2.0"
      sourceRef:
        kind: HelmRepository
        name: k8s-home-lab
        namespace: media
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - mainboy
    persistence:
      media:
        enabled: true
        existingClaim: media-nfs-pvc
        mountPath: /media
      config:
        enabled: true
        existingClaim: plex-config-pvc
        mountPath: /config

    podSecurityContext:
      fsGroup: 65534
      fsGroupChangePolicy: "OnRootMismatch"
---
# Transmission
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: transmission
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: transmission
      version: "1.7.0"
      sourceRef:
        kind: HelmRepository
        name: lexfrei-charts
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values: [mainboy]
    podSecurityContext:
      fsGroup: 100
      fsGroupChangePolicy: "OnRootMismatch"
    env:
      TZ: Australia/Sydney
      PUID: "1000"
      PGID: "1000"
    service:
      torrent:
        enabled: false
    persistence:
      downloads:
        enabled: true
        type: pvc
        existingClaim: media-nfs-pvc
        mountPath: /downloads
      config:
        enabled: true
        existingClaim: transmission-config-pvc
        mountPath: /config
    config:
      download-dir: /downloads/downloads/complete
      incomplete-dir-enabled: true
      incomplete-dir: /downloads/downloads/incomplete
      watch-dir-enabled: true
      watch-dir: /downloads/downloads/watch
    extraContainers:
      - name: gluetun
        image: ghcr.io/qdm12/gluetun:latest
        securityContext:
          capabilities:
            add: ["NET_ADMIN", "NET_RAW"]
        env:
          - name: VPN_SERVICE_PROVIDER
            value: protonvpn
          - name: VPN_TYPE
            value: wireguard
          - name: WIREGUARD_PRIVATE_KEY
            valueFrom:
              secretKeyRef:
                name: protonvpn-wg
                key: privatekey
          - name: FIREWALL
            value: "on"
          - name: FIREWALL_INPUT_PORTS
            value: "9091"
          - name: FIREWALL_OUTBOUND_SUBNETS
            value: "10.42.0.0/16,10.43.0.0/16,192.168.0.0/16"
          - name: VPN_PORT_FORWARDING
            value: "on"
          - name: PORT_FORWARD_ONLY
            value: "on"
    initContainers:
      - name: fix-perms-and-dirs
        image: busybox:1.36
        command:
          - sh
          - -c
          - |
            set -eux
            # Ensure Transmission can write its config
            mkdir -p /config
            chown -R 1000:1000 /config
            chmod -R u+rwX,g+rwX /config

            # Ensure download dirs exist at the exact paths Transmission is configured to use
            mkdir -p /downloads/downloads/complete /downloads/downloads/incomplete /downloads/downloads/watch
            chown -R 1000:1000 /downloads/downloads
            chmod -R u+rwX,g+rwX /downloads/downloads
        securityContext:
          runAsUser: 0
        volumeMounts:
          - name: config
            mountPath: /config
          - name: downloads
            mountPath: /downloads
---
# Prowlarr
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: prowlarr
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: prowlarr
      version: "5.2.1"
      sourceRef:
        kind: HelmRepository
        name: k8s-home-lab
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values: [mainboy]
    # Longhorn permissions
    podSecurityContext:
      fsGroup: 100
      fsGroupChangePolicy: "OnRootMismatch"
    persistence:
      config:
        enabled: true
        existingClaim: prowlarr-config-pvc
        mountPath: /config