# Radarr
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: radarr
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: radarr
      version: "17.4.0"
      sourceRef:
        kind: HelmRepository
        name: k8s-home-lab
        namespace: media
      interval: 1h
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - mainboy
    persistence:
      media:
        enabled: true
        existingClaim: media-nfs-pvc
        mountPath: /media
      config:
        enabled: true
        existingClaim: radarr-config-pvc
        mountPath: /config

    podSecurityContext:
      fsGroup: 100
      fsGroupChangePolicy: "OnRootMismatch"
---
# Sonarr
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: sonarr
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: sonarr
      version: "17.2.1"
      sourceRef:
        kind: HelmRepository
        name: k8s-home-lab
        namespace: media
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - mainboy
    persistence:
      media:
        enabled: true
        existingClaim: media-nfs-pvc
        mountPath: /media
      config:
        enabled: true
        existingClaim: sonarr-config-pvc
        mountPath: /config

    podSecurityContext:
      fsGroup: 100
      fsGroupChangePolicy: "OnRootMismatch"
---
#Plex
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: plex
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: plex
      version: "7.2.0"
      sourceRef:
        kind: HelmRepository
        name: k8s-home-lab
        namespace: media
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - mainboy
    persistence:
      media:
        enabled: true
        existingClaim: media-nfs-pvc
        mountPath: /media
      config:
        enabled: true
        existingClaim: plex-config-pvc
        mountPath: /config

    podSecurityContext:
      fsGroup: 65534
      fsGroupChangePolicy: "OnRootMismatch"
---
# Transmission
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: transmission
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: transmission
      version: "1.7.0"
      sourceRef:
        kind: HelmRepository
        name: lexfrei-charts
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: StatefulSet
              name: transmission
            patch: |
              - op: remove
                path: /spec/template/spec/containers/0/livenessProbe
              - op: remove
                path: /spec/template/spec/containers/0/readinessProbe
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values: [mainboy]
    podSecurityContext:
      fsGroup: 1000 
      fsGroupChangePolicy: "OnRootMismatch"
    env:
      TZ: Australia/Sydney
      PUID: "1000"
      PGID: "1000"
      TRANSMISSION_WATCH_DIR: /downloads/downloads/watch
    service:
      torrent:
        enabled: true
    persistence:
      downloads:
        enabled: true
        type: pvc
        existingClaim: media-nfs-pvc
        mountPath: /downloads
      config:
        enabled: true
        existingClaim: transmission-config-pvc
        mountPath: /config
    config:
      download-dir: /downloads/downloads/complete
      incomplete-dir-enabled: true
      incomplete-dir: /downloads/downloads/incomplete
      watch-dir-enabled: true
      watch-dir: /downloads/downloads/watch
    extraContainers:
      - name: gluetun
        image: ghcr.io/qdm12/gluetun:latest
        securityContext:
          capabilities:
            add: ["NET_ADMIN", "NET_RAW"]
        volumeMounts:
          - name: gluetun-shared
            mountPath: /tmp/gluetun
        env:
          - name: VPN_SERVICE_PROVIDER
            value: protonvpn
          - name: VPN_TYPE
            value: wireguard
          - name: WIREGUARD_PRIVATE_KEY
            valueFrom:
              secretKeyRef:
                name: protonvpn-wg
                key: privatekey
          - name: OPENVPN_USER
            valueFrom:
              secretKeyRef:
                name: protonvpn-credentials
                key: username_pmp
          - name: OPENVPN_PASSWORD
            valueFrom:
              secretKeyRef:
                name: protonvpn-credentials
                key: password
          - name: VPN_PORT_FORWARDING_USERNAME
            valueFrom:
              secretKeyRef:
                name: protonvpn-credentials
                key: username_pmp
          - name: VPN_PORT_FORWARDING_PASSWORD
            valueFrom:
              secretKeyRef:
                name: protonvpn-credentials
                key: password
          - name: WIREGUARD_ADDRESSES
            value: "10.2.0.2/32"
          - name: SERVER_COUNTRIES
            value: "Australia"
          - name: FIREWALL
            value: "on"
          - name: FIREWALL_INPUT_PORTS
            value: "9091"
          - name: FIREWALL_OUTBOUND_SUBNETS
            value: "10.42.0.0/16,10.43.0.0/16,192.168.0.0/16"
          - name: VPN_PORT_FORWARDING
            value: "on"
          - name: PORT_FORWARD_ONLY
            value: "on"
          - name: WIREGUARD_MTU
            value: "1320"
          - name: WIREGUARD_PERSISTENT_KEEPALIVE_INTERVAL
            value: "15s"
      - name: port-updater
        image: curlimages/curl:latest
        command:
          - sh
          - -c
          - |
            sleep 60
            LAST_PORT=""
            while true; do
              if [ -f /tmp/gluetun/forwarded_port ]; then
                PORT=$(cat /tmp/gluetun/forwarded_port | tr -d '[:space:]')
                if [ -n "$PORT" ] && [ "$PORT" != "$LAST_PORT" ]; then
                  SID=$(curl -s -D - http://localhost:9091/transmission/rpc/ 2>/dev/null | grep -i X-Transmission-Session-Id | tr -d '\r' | awk '{print $2}')
                  if [ -n "$SID" ]; then
                    curl -s http://localhost:9091/transmission/rpc/ \
                      -H "X-Transmission-Session-Id: $SID" \
                      -d '{"method":"session-set","arguments":{"peer-port":'"$PORT"'}}' > /dev/null
                    echo "Port updated to $PORT"
                  fi
                  LAST_PORT=$PORT
                fi
              fi
              sleep 30
            done
        volumeMounts:
          - name: gluetun-shared
            mountPath: /tmp/gluetun
            readOnly: true
    extraVolumes:
      - name: protonvpn-wg
        secret:
          secretName: protonvpn-wg
      - name: gluetun-shared
        emptyDir: {}
    extraVolumeMounts:
      - name: protonvpn-wg
        mountPath: /secrets
        readOnly: true
      - name: gluetun-shared
        mountPath: /tmp/gluetun
    initContainers:
      - name: fix-config-perms
        image: busybox:1.36
        securityContext:
          runAsUser: 0
        command:
          - sh
          - -c
          - |
            set -eux
            # Create settings.json if it doesn't exist
            if [ ! -f /config/settings.json ]; then
              echo '{}' > /config/settings.json
            fi
            # Fix all permissions
            chown -R 1000:1000 /config
            chmod 2775 /config
            chmod -R u+rwX,g+rwX /config
            chmod 666 /config/settings.json
        volumeMounts:
          - name: config
            mountPath: /config

---
# Prowlarr
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: prowlarr
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: prowlarr
      version: "5.2.1"
      sourceRef:
        kind: HelmRepository
        name: k8s-home-lab
  values:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values: [mainboy]
    # Longhorn permissions
    podSecurityContext:
      fsGroup: 100
      fsGroupChangePolicy: "OnRootMismatch"
    persistence:
      config:
        enabled: true
        existingClaim: prowlarr-config-pvc
        mountPath: /config